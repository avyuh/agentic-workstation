#!/bin/bash
set -euo pipefail

# Start Claude Code headless in a tmux session.
# Usage: agent-run <session-name> "<prompt>"
#
# The session name can be a project name (looks in ~/projects/) or
# a worktree name (looks in ~/worktrees/). If neither exists, uses
# the name as a tmux session with the current directory.

PROJECTS_DIR="${HOME}/projects"
WORKTREES_DIR="${HOME}/worktrees"
LOGS_DIR="${HOME}/.agent-logs"

if [ $# -lt 2 ]; then
    echo "Usage: agent-run <session-name> \"<prompt>\""
    echo ""
    echo "Examples:"
    echo "  agent-run myproject \"Add user authentication\""
    echo "  agent-run myproject-feat-auth \"Implement JWT middleware\""
    exit 1
fi

SESSION="$1"
PROMPT="$2"

# Determine working directory
if [ -d "$WORKTREES_DIR/$SESSION" ]; then
    WORK_DIR="$WORKTREES_DIR/$SESSION"
elif [ -d "$PROJECTS_DIR/$SESSION" ]; then
    WORK_DIR="$PROJECTS_DIR/$SESSION"
else
    echo "Error: No project or worktree found for '$SESSION'"
    echo "  Looked in: $PROJECTS_DIR/$SESSION"
    echo "  Looked in: $WORKTREES_DIR/$SESSION"
    exit 1
fi

# Create logs directory
mkdir -p "$LOGS_DIR"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
LOG_FILE="$LOGS_DIR/${SESSION}-${TIMESTAMP}.log"

# Write prompt to temp file to avoid quoting issues in tmux send-keys
PROMPT_FILE=$(mktemp)
echo "$PROMPT" > "$PROMPT_FILE"

# Kill existing session if running
if tmux has-session -t "agent-$SESSION" 2>/dev/null; then
    echo "Warning: Session 'agent-$SESSION' already exists. Killing it."
    tmux kill-session -t "agent-$SESSION"
fi

# Create tmux session and run claude headless
tmux new-session -d -s "agent-$SESSION" -c "$WORK_DIR"

# Source env and run claude with prompt, logging output
tmux send-keys -t "agent-$SESSION" \
    "[ -f \"\$HOME/.env\" ] && set -a && . \"\$HOME/.env\" && set +a; claude -p \"\$(cat $PROMPT_FILE)\" 2>&1 | tee $LOG_FILE; echo \"=== AGENT FINISHED (exit: \$?) ===\"; rm -f $PROMPT_FILE" Enter

echo "Agent started: agent-$SESSION"
echo "Working dir:   $WORK_DIR"
echo "Log file:      $LOG_FILE"
echo ""
echo "Commands:"
echo "  agent-log $SESSION       — tail output"
echo "  agent-status             — list all sessions"
echo "  agent-stop $SESSION      — stop the agent"
echo "  tmux attach -t agent-$SESSION — attach to session"
